package main

import (
	"bufio"
	"fmt"
	"os"

	"github.com/skkim-01/cve-reporter/internals"
	JsonMapper "github.com/skkim-01/json-mapper/src"
)

func _process(pCSV *os.File, strFile string) {
	jsonMap, err := internals.ReadFromFile(strFile)
	if err != nil {
		fmt.Println(err)
		return
	}

	fmt.Println("#DBG\tFile:\t", strFile)
	fmt.Println("#DBG\tTotalCount from JSON:\t", jsonMap.Find("totalResults"))
	fmt.Println("#DBG\tTotalCount from Object:\t", len(jsonMap.Find("vulnerabilities").([]interface{})))

	for i, _ := range jsonMap.Find("vulnerabilities").([]interface{}) {
		pCSV.WriteString(fmt.Sprintf("%v, %v, %v, %v, %v, %v, \"%v\"\r\n",
			jsonMap.Find(fmt.Sprintf("vulnerabilities.%v.cve.id", i)),
			jsonMap.Find(fmt.Sprintf("vulnerabilities.%v.cve.published", i)),
			jsonMap.Find(fmt.Sprintf("vulnerabilities.%v.cve.lastModified", i)),
			jsonMap.Find(fmt.Sprintf("vulnerabilities.%v.cve.sourceIdentifier", i)),
			jsonMap.Find(fmt.Sprintf("vulnerabilities.%v.cve.metrics.cvssMetricV2.0.baseSeverity", i)),
			jsonMap.Find(fmt.Sprintf("vulnerabilities.%v.cve.metrics.cvssMetricV2.0.cvssData.baseScore", i)),
			internals.GetDescription(i, jsonMap),
		))
	}
	return
}

func main() {
	pCSV, err := internals.InitCSV()
	if err != nil {
		fmt.Println(err)
		return
	}
	defer pCSV.Close()

	_process(pCSV, "./res/01.txt")
	_process(pCSV, "./res/02.txt")
	_process(pCSV, "./res/03.txt")
	_process(pCSV, "./res/04.txt")
	_process(pCSV, "./res/05.txt")
	_process(pCSV, "./res/06.txt")
	_process(pCSV, "./res/07.txt")
	_process(pCSV, "./res/08.txt")
	_process(pCSV, "./res/09.txt")
	_process(pCSV, "./res/10.txt")
	_process(pCSV, "./res/11.txt")
	_process(pCSV, "./res/12.txt")

	return

	pFile, err := os.Open("./res/1.gov")
	defer pFile.Close()
	if err != nil {
		fmt.Println(err)
		return
	}
	buffer := make([]byte, 15000000)
	nBytes, err := pFile.Read(buffer)
	if err != nil {
		fmt.Println(err)
		return
	}

	mapJson, err := JsonMapper.NewBytes(buffer[:nBytes])
	if err != nil {
		fmt.Println(err)
		return
	}
	fmt.Println(mapJson.PPrint())
}

func main_bak() {

	pfIdx, err := os.Open("./res/us-east-2.txt")
	defer pfIdx.Close()
	if err != nil {
		fmt.Println(err)
	}
	fileScanner := bufio.NewScanner(pfIdx)
	fileScanner.Split(bufio.ScanLines)
	var fileLines []string

	for fileScanner.Scan() {
		fileLines = append(fileLines, fileScanner.Text())
	}

	// initcsv
	fp, err := internals.InitCSV()
	if err != nil {
		fmt.Println(err)
		return
	}
	defer fp.Close()

	// append file test
	fp.WriteString("1\r\n")
	fp.WriteString("2\r\n")
	fp.WriteString("3\r\n")
	return

	for i := 0; i < 3; i++ {
		fmt.Println("#DBG\tid:\t", fileLines)
		result, err := internals.Call(fileLines[i])
		if err != nil {
			fmt.Println(err)
			continue
		}

		internals.WriteObject(fp, result)
		if err != nil {
			fmt.Println(err)
			continue
		}
	}
}
