package internals

import (
	"fmt"
	"os"
	"strings"

	HttpsUtil "github.com/skkim-01/cve-reporter/utils/httpsutil"
	JsonMapper "github.com/skkim-01/json-mapper/src"
)

func InitCSV() (*os.File, error) {
	pCSV, err := os.Create("results.csv")
	if err != nil {
		return nil, err
	}

	pCSV.WriteString("id, published, lastModified, identifier, serverity, score, description \r\n")
	return pCSV, nil
}

func WriteObject(pCSV *os.File, jsonMap *JsonMapper.JsonMap) error {
	// fmt.Sprintf("%v, %v, %v, %v, %v, %v, %v, %v",
	// 	jsonMap.Find("id"),
	// 	jsonMap.Find("published"),
	// 	jsonMap.Find("lastModified"),
	// 	jsonMap.Find("sourceIdentifier"),
	// 	jsonMap.Find("baseSeverity"),
	// 	jsonMap.Find("baseScore"),
	// 	jsonMap.Find("accessVector"),
	// 	jsonMap.Find("description"),
	// )
	_, err := pCSV.WriteString(fmt.Sprintf("%v, %v, %v, %v, %v, %v, %v, \"%v\"\r\n",
		jsonMap.Find("id"),
		jsonMap.Find("published"),
		jsonMap.Find("lastModified"),
		jsonMap.Find("sourceIdentifier"),
		jsonMap.Find("baseSeverity"),
		jsonMap.Find("baseScore"),
		jsonMap.Find("accessVector"),
		jsonMap.Find("description"),
	))
	return err
}

func Call(id string) (*JsonMapper.JsonMap, error) {
	url := "https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=" + id
	conn := HttpsUtil.NewReqInfo()
	conn.SetURL(url)
	conn.SetMethod("GET")
	conn.AppendHeader("Content-Type", "application/json")
	response, err := HttpsUtil.SendRequest(conn)
	if nil != err {
		fmt.Println(err)
		return nil, err
	}

	jsonResponse, err := HttpsUtil.ResponseBodyParser(response)
	if nil != err {
		fmt.Println(err)
		return nil, err
	}

	//fmt.Println(jsonResponse.PPrint())
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.id"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.published"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.lastModified"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.sourceIdentifier"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssMetricV2.0.baseSeverity"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssMetricV2.0.cvssData.baseScore"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssMetricV2.0.cvssData.accessVector"))
	// fmt.Println(jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssmetricV2.0.cvssData.accessVector"))

	jsonResult, _ := JsonMapper.NewBytes([]byte("{}"))
	jsonResult.Insert("", "id", jsonResponse.Find("vulnerabilities.0.cve.id"))
	jsonResult.Insert("", "published", jsonResponse.Find("vulnerabilities.0.cve.published"))
	jsonResult.Insert("", "lastModified", jsonResponse.Find("vulnerabilities.0.cve.lastModified"))
	jsonResult.Insert("", "sourceIdentifier", jsonResponse.Find("vulnerabilities.0.cve.sourceIdentifier"))
	jsonResult.Insert("", "baseSeverity", jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssMetricV2.0.baseSeverity"))
	jsonResult.Insert("", "baseScore", jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssMetricV2.0.cvssData.baseScore"))
	jsonResult.Insert("", "accessVector", jsonResponse.Find("vulnerabilities.0.cve.metrics.cvssMetricV2.0.cvssData.accessVector"))
	//jsonResult.Insert("", "description", _getDescription(jsonResponse))

	return jsonResult, nil
}

func GetDescription(idx int, mapJson *JsonMapper.JsonMap) string {
	mapDescriptions := mapJson.Find(fmt.Sprintf("vulnerabilities.%v.cve.descriptions", idx)).([]interface{})
	for k, _ := range mapDescriptions {

		strLanguage := mapJson.Find(fmt.Sprintf("vulnerabilities.%v.cve.descriptions.%v.lang", idx, k)).(string)
		if strings.Compare(strLanguage, "en") == 0 {
			return mapJson.Find(fmt.Sprintf("vulnerabilities.%v.cve.descriptions.%v.value", idx, k)).(string)
		}
	}
	return ""
}

func _getDescription(idx int, mapJson *JsonMapper.JsonMap) string {
	mapDescriptions := mapJson.Find(fmt.Sprintf("vulnerabilities.%v.cve.descriptions", idx)).([]interface{})
	for k, _ := range mapDescriptions {

		strLanguage := mapJson.Find(fmt.Sprintf("vulnerabilities.%v.cve.descriptions.%v.lang", idx, k)).(string)
		if strings.Compare(strLanguage, "en") == 0 {
			return mapJson.Find(fmt.Sprintf("vulnerabilities.%v.cve.descriptions.%v.value", idx, k)).(string)
		}
	}
	return ""
}
